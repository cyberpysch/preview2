{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'usermanagement/css/style.css' %}">
</head>
<body>

<div class="page-wrapper">
    <nav id="sidebar" class="bg-dark text-white shadow position-fixed h-100">
        <div class="p-3"><h5 class="fw-bold text-info mb-0">PROINPLAY</h5></div>
        <hr class="mt-0 opacity-25">
        <ul class="nav nav-pills flex-column mb-auto px-2">
            <li><a href="#" id="defaultDashboardView" class="nav-link text-white active mb-1">Dashboard</a></li>
            <li>
                <a href="#roleSubmenu" data-bs-toggle="collapse" class="nav-link text-white d-flex justify-content-between">
                    <span>{{ role }}</span><span>▼</span>
                </a>
                <ul id="roleSubmenu" class="collapse list-unstyled ps-3 mt-1">
                    {% for role_name in downline_roles %}
                    <li><a href="#" class="nav-link text-white-50 role-link" data-role="{{ role_name }}">{{ role_name }}</a></li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    </nav>

    <div class="flex-grow-1 d-flex flex-column">
        <header class="custom-header d-flex align-items-center px-3 sticky-top">
            <button class="btn btn-sm btn-outline-dark d-md-none me-2" id="sidebarToggle">☰</button>
            <div class="flex-grow-1 d-flex justify-content-between align-items-center">
                <span class="fw-bold" data-username="{{ request.user.username }}">{{ request.user.username }} <span class="badge bg-info text-dark ms-2">{{ role }}</span></span>
                <div class="dropdown">
            <button class="btn btn-sm btn-outline-dark dropdown-toggle"
                    type="button"
                    id="userDropdown"
                    data-bs-toggle="dropdown"
                    aria-expanded="false">
                {{ request.user.first_name }}
            </button>

            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <!-- Reset Password triggers modal -->
                <li>
                    <a class="dropdown-item" href="#"
                       data-bs-toggle="modal"
                       data-bs-target="#resetPasswordModal">
                        Reset Password
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <!-- Logout -->
                <li>
                    <a class="dropdown-item text-danger" href="{% url 'logout' %}">
                        Logout
                    </a>
                </li>
        </div>
            </div>
        </header>
        <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="resetPasswordModalLabel">Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="resetMessage" class="mb-2 text-success" style="display:none;"></div>
        <input type="password" id="newPassword" class="form-control" placeholder="Enter New Password">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="resetPassword()">Update Password</button>
      </div>

    </div>
  </div>
</div>

        <main id="content" class="p-4">
          <div id="dashboardContent">
    <div class="container-fluid px-0 mb-4">
        <div class="row g-0 custom-stats-row mb-1">
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MY USER NAME</div>
                <div class="stats-value text-uppercase">{{ request.user.username }}({{ request.user.first_name }})</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MY LEVEL</div>
                <div class="stats-value text-uppercase">{{ role }}</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">BALANCE</div>
                <div class="stats-value">{{ coins }}</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MEMBERS</div>
                <div class="stats-value">{{ members_count }}</div>
            </div>
        </div>

        <div class="row g-0 custom-stats-row">
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MY SHARE</div>
                <div class="stats-value">{{ my_share }} %</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">COMPANY SHARE</div>
                <div class="stats-value">{{ company_share|default:"0" }} %</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MATCH COMMISSION</div>
                <div class="stats-value">{{ match_commission }} %</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">SESSION COMMISSION</div>
                <div class="stats-value">{{ session_commission|default:"0" }} %</div>
            </div>
        </div>
    </div>
</div>
            <div id="dynamicContent" style="display:none;"></div>
        </main>
    </div>
</div>

<div class="modal fade" id="uplineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white py-2">
                <h6 class="modal-title">Select Upline Manager</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <label class="small fw-bold text-muted">Select Parent</label>
                <select class="form-select mb-4" id="parentSelect"></select>
                <button class="btn btn-primary w-100" onclick="proceedToRegistration()">Proceed to Registration</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="{% static 'usermanagement/js/dashboard.js' %}"></script>
</body>
<script>
/**
 * Main function to handle the Edit User flow
 */

function handleEditClick(username) {
    const dynamicDiv = document.getElementById('dynamicContent');
    const dashDiv = document.getElementById('dashboardContent');

    // Show loading spinner
    dashDiv.style.display = 'none';
    dynamicDiv.style.display = 'block';
    dynamicDiv.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary"></div>
            <p>Loading Profile for ${username}...</p>
        </div>`;

    // 1️⃣ Fetch the Form HTML Template
    fetch(`/get-edit-form/?username=${username}`)
        .then(res => {
            if (!res.ok) throw new Error("Failed to load form template");
            return res.text();
        })
        .then(html => {
            dynamicDiv.innerHTML = html;

            // 2️⃣ Fetch the Actual Account Data to fill the form
            return fetch(`/api/get-account-data/${username}/`);
        })
        .then(res => {
            if (!res.ok) throw new Error(`Data fetch failed: ${res.status}`);
            return res.json();
        })
        .then(data => {
            const form = document.getElementById('editUserForm');
            if (!form) return;

            // 3️⃣ Populate form fields FIRST
            Object.keys(data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = Boolean(data[key]);
                    } else {
                        input.value = data[key];
                    }
                }
            });
            // ===============================
            // FORCE match_share = 0 FOR CLIENT
            // ===============================
            
            // Grab all fields FIRST
            const parentField = document.getElementById("parent_match_share");
            const childField = document.getElementById("child_match_Share");
            const childRow = document.getElementById("childMatchRow");

            const parentCasinoField = document.getElementById("parent_casino_share");
            const childCasinoField = document.getElementById("child_casino_share");
            const childCasinoRow = document.getElementById("childCasinoRow");

            const toggle = document.getElementById("toggleShare");
            // Client-specific logic
            if (data.role && data.role.toLowerCase() === "client") {
            
                if (childField) {
                    childField.value = "0.00";   // always 0
                    childField.readOnly = true;  // cannot edit
                }
            
                if (childRow) {
                    childRow.style.display = "none"; // hide row visually
                }
            
                if (parentField) {
                    parentField.readOnly = false;    // parent editable
                }
                if (childCasinoField) {
                    childCasinoField.value = "0.00";
                    childCasinoField.readOnly = true;
                }

                if (childCasinoRow) {
                    childCasinoRow.style.display = "none";
                }
            }
            
                    
            // Total limit (set via data attribute or hardcoded)
            const totalLimit = parseFloat(parentField.dataset.total) || 100; // example total
                    
            if (!childField || !parentField) return;
                    
            // Store original child value
            let originalChildValue = parseFloat(childField.value) || 0;
                    
            // 1️⃣ Checkbox toggle logic
            //if (toggle) {
            //    toggle.addEventListener("change", function () {
            //        if (this.checked) {
            //            parentField.readOnly = false;
            //            childField.readOnly = true;
            //        } else {
            //            parentField.readOnly = true;
            //            childField.readOnly = false;
            //        }
            //    });
            //}
            if (toggle) {
                toggle.addEventListener("change", function () {
                
                    const isChecked = this.checked;
                
                    // MATCH FIELDS
                    if (parentField) parentField.readOnly = !isChecked;
                    if (childField) childField.readOnly = isChecked;
                
                    // CASINO FIELDS
                    if (parentCasinoField) parentCasinoField.readOnly = !isChecked;
                    if (childCasinoField) childCasinoField.readOnly = isChecked;
                
                });
            }
            
            // 2️⃣ Utility function to clamp value within min and max
            function clamp(value, min, max) {
                return Math.min(Math.max(value, min), max);
            }
            
            // 3️⃣ Child → Parent difference logic
            childField.addEventListener("input", function () {

            const value = childField.value;

            // Allow only valid decimal typing
            if (!/^\d*\.?\d*$/.test(value)) {
                childField.value = value.slice(0, -1);
                return;
            }
        
            // If user just typed "." or empty, don't calculate yet
            if (value === "" || value === ".") {
                return;
            }
        
            let typedChild = parseFloat(value);
            if (isNaN(typedChild)) typedChild = 0;
        
            typedChild = clamp(typedChild, 0, totalLimit);
        
            let parentVal = parseFloat(parentField.value);
            if (isNaN(parentVal)) parentVal = 0;
        
            let diff = originalChildValue - typedChild;
            let newParentVal = clamp(parentVal + diff, 0, totalLimit);
        
            if (typedChild + newParentVal > totalLimit) {
                alert(`Child + Parent cannot exceed total of ${totalLimit}`);
                childField.value = originalChildValue;
                return;
            }
        
            parentField.value = newParentVal;
            originalChildValue = typedChild;
        });
            
            // 4️⃣ Parent input if editable
            parentField.addEventListener("input", function () {
            const value = parentField.value;

            // ✅ Allow only valid decimal typing
            if (!isValidDecimal(value)) {
                parentField.value = value.slice(0, -1);
                return;
            }
        
            // If user just typed "." or empty, don't calculate yet
            if (value === "" || value === ".") return;
        
            let typedParent = parseFloat(value) || 0;
            typedParent = clamp(typedParent, 0, totalLimit);
        
            let childVal = parseFloat(childField.value) || 0;
        
            // Ensure sum of both does not exceed total
            if (typedParent + childVal > totalLimit) {
                alert(`Parent + Child cannot exceed total of ${totalLimit}`);
                parentField.value = clamp(totalLimit - childVal, 0, totalLimit);
                return;
            }
        
            parentField.value = typedParent;
        });
            
            // ===============================
            // CASINO SHARE TRANSFER LOGIC (FIXED)
            // ===============================

            const totalLimitCasino = parseFloat(parentCasinoField?.dataset.total) || 0;
            let originalChildCasinoValue = parseFloat(childCasinoField?.value) || 0;

            if (childCasinoField && parentCasinoField) {
            
                // CHILD → PARENT (difference logic like match)
                childCasinoField.addEventListener("input", function () {
                const value = childCasinoField.value;
                            
                // ✅ Allow only valid decimal typing
                if (!isValidDecimal(value)) {
                    childCasinoField.value = value.slice(0, -1);
                    return;
                }
            
                // If user just typed "." or empty, don't calculate yet
                if (value === "" || value === ".") return;
            
                let typedChild = parseFloat(value) || 0;
                typedChild = clamp(typedChild, 0, totalLimitCasino);
            
                let parentVal = parseFloat(parentCasinoField.value) || 0;
                let diff = originalChildCasinoValue - typedChild;
                let newParentVal = clamp(parentVal + diff, 0, totalLimitCasino);
            
                if (typedChild + newParentVal > totalLimitCasino) {
                    alert(`Casino Child + Parent cannot exceed total of ${totalLimitCasino}`);
                    childCasinoField.value = originalChildCasinoValue;
                    return;
                }
            
                childCasinoField.value = typedChild;
                parentCasinoField.value = newParentVal;
            
                originalChildCasinoValue = typedChild;
            });
            
                // PARENT EDIT (no transfer to child, only restrict total)
                parentCasinoField.addEventListener("input", function () {
                
                    let typedParent = parseFloat(parentCasinoField.value) || 0;
                
                    typedParent = clamp(typedParent, 0, totalLimitCasino);
                
                    let childVal = parseFloat(childCasinoField.value) || 0;
                
                    if (typedParent + childVal > totalLimitCasino) {
                        parentCasinoField.value = clamp(totalLimitCasino - childVal, 0, totalLimitCasino);
                        return;
                    }
                
                    parentCasinoField.value = typedParent;
                });
            }
            // 7️⃣ Form submission
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                // Ensure Client always submits 0
                if (data.role && data.role.toLowerCase() === "client") {
                    childField.value = "0.00";
                    parentField.value = clamp(parseFloat(parentField.value) || 0, 0, totalLimit).toFixed(2);
                    if (childCasinoField) {
                        childCasinoField.value = "0.00";
                        
                    }
                }
                // Apply final diff to ensure correct values before submit
                const newChildValue = parseFloat(childField.value) || 0;
                const diff = originalChildValue - newChildValue;
                parentField.value = (parseFloat(parentField.value) + diff).toFixed(2);
                childField.value = newChildValue.toFixed(2);

                // Final Casino Adjustment Before Submit
                if (childCasinoField && parentCasinoField) {
                
                    const newChildCasinoValue = parseFloat(childCasinoField.value) || 0;
                    const diffCasino = originalChildCasinoValue - newChildCasinoValue;
                
                    parentCasinoField.value = (
                        parseFloat(parentCasinoField.value) + diffCasino
                    ).toFixed(2);
                
                    childCasinoField.value = newChildCasinoValue.toFixed(2);
                }

                const formData = new FormData(form);
                const jsonData = Object.fromEntries(formData.entries());

                // Handle checkboxes manually
                const checkBoxes = form.querySelectorAll('input[type="checkbox"]');
                checkBoxes.forEach(cb => {
                    jsonData[cb.name] = cb.checked;
                });

                // Send POST request
                fetch(`/api/accounts/edit/${username}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success') {
                        alert("Successfully Updated!");
                        // Optionally refresh or navigate
                        // location.reload();
                    } else {
                        alert("Error: " + result.message);
                    }
                })
                .catch(err => {
                    console.error("Save Error:", err);
                    alert("Failed to save changes.");
                });
            });

        })
        .catch(err => {
            console.error("Edit Flow Error:", err);
            dynamicDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
        });
}

/**
 * Utility: Get CSRF Token for Django POST requests
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<script>

function handleDepositClick(username) {

    const modalElement = document.getElementById("depositModal");

    if (!modalElement) {
        console.error("depositModal not found");
        return;
    }

    document.getElementById("depositUsername").value = username;
    document.getElementById("depositAmount").value = "";

    const depositModal = new bootstrap.Modal(modalElement);
    depositModal.show();
}

function submitDeposit() {

    const username = document.getElementById("depositUsername").value;
    const amount = parseInt(document.getElementById("depositAmount").value);

    if (!amount || amount <= 0) {
        alert("Enter valid amount");
        return;
    }

    fetch("/api/deposit-coins/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
            username: username,
            amount: amount
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Deposit successful");
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(() => alert("Server error"));
}


/* CSRF helper (safe for Django) */
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

</script>
<script>
    function handleWithdrawClick(username) {

    const modalElement = document.getElementById("withdrawModal");

    document.getElementById("withdrawUsername").value = username;
    document.getElementById("withdrawAmount").value = "";

    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}


function submitWithdraw() {

    const username = document.getElementById("withdrawUsername").value;
    const amount = parseInt(document.getElementById("withdrawAmount").value);

    if (!amount || amount <= 0) {
        alert("Enter valid amount");
        return;
    }

    fetch("/api/withdraw-coins/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({
            username: username,
            amount: amount
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Withdraw successful");
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(() => alert("Server error"));
}

</script>
<script>
    let statementState = {
    username: null,
    currentPage: 1,
    totalPages: 1,
    startDate: null,
    endDate: null
};

function handleStatementClick(username) {

    statementState.username = username;
    statementState.currentPage = 1;
    statementState.startDate = null;
    statementState.endDate = null;

    const dashDiv = document.getElementById("dashboardContent");
    const dynamicDiv = document.getElementById("dynamicContent");

    dashDiv.style.display = "none";
    dynamicDiv.style.display = "block";

    fetch(`/accounts/statement-partial/`)
        .then(res => res.text())
        .then(html => {
            dynamicDiv.innerHTML = html;
            loadStatement();
        });
}

function loadStatement() {

    let url = `/api/account-statement/?username=${statementState.username}&page=${statementState.currentPage}`;

    if (statementState.startDate && statementState.endDate) {
        url += `&start_date=${statementState.startDate}&end_date=${statementState.endDate}`;
    }

    fetch(url)
        .then(res => res.json())
        .then(data => {

            document.getElementById("totalRecords").innerText = data.total_records;

            statementState.totalPages = data.total_pages;
            document.getElementById("currentPageNumber").innerText = data.current_page;

            renderStatementTable(data.results);
            updatePaginationButtons();
        });
}

function renderStatementTable(results) {

    const tbody = document.getElementById("statementTableBody");
    tbody.innerHTML = "";

    results.forEach(tx => {

        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${tx.datetime}</td>
            <td>${tx.description}</td>
            <td class="text-end">${parseFloat(tx.prev_balance).toFixed(2)}</td>
            <td class="text-end ${tx.cr > 0 ? 'text-success' : ''}">
                ${parseFloat(tx.cr).toFixed(2)}
            </td>
            <td class="text-end ${tx.dr > 0 ? 'text-danger' : ''}">
                ${parseFloat(tx.dr).toFixed(2)}
            </td>
            <td class="text-end text-success">
                ${parseFloat(tx.comm_plus).toFixed(2)}
            </td>
            <td class="text-end text-danger">
                ${parseFloat(tx.comm_minus).toFixed(2)}
            </td>
            <td class="text-end">${parseFloat(tx.current_balance).toFixed(2)}</td>
        `;

        tbody.appendChild(tr);
    });
}


function changeStatementPage(direction) {

    const newPage = statementState.currentPage + direction;

    if (newPage < 1 || newPage > statementState.totalPages) return;

    statementState.currentPage = newPage;
    loadStatement();
}

function updatePaginationButtons() {

    document.getElementById("prevPageBtn").disabled =
        statementState.currentPage <= 1;

    document.getElementById("nextPageBtn").disabled =
        statementState.currentPage >= statementState.totalPages;
}

function applyStatementFilter() {

    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    if (!start || !end) {
        alert("Both dates are required");
        return;
    }

    if (start > end) {
        alert("Start date cannot be greater than end date");
        return;
    }

    statementState.startDate = start;
    statementState.endDate = end;
    statementState.currentPage = 1;

    loadStatement();
}

function resetStatementFilter() {

    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";

    statementState.startDate = null;
    statementState.endDate = null;
    statementState.currentPage = 1;

    loadStatement();
}

function closeStatement() {

    document.getElementById("dynamicContent").style.display = "none";
    document.getElementById("dashboardContent").style.display = "block";
}

</script>
<script>
$(document).on("click", ".account-operations-link", function(e) {
    e.preventDefault();

    var url = $(this).attr("href");

    $.ajax({
        url: url,
        type: "GET",
        success: function(response) {
            $("#operations-container").html(response);
        },
        error: function(xhr) {
            console.log("Error:", xhr.responseText);
        }
    });
});

</script>
<script>
    document.addEventListener("click", function (e) {

    const link = e.target.closest(".toggle-status");
    if (!link) return;

    e.preventDefault();

    const username = link.dataset.username;
    const currentState = link.dataset.active.trim().toLowerCase() === "true";
    const newState = !currentState;

    fetch("/api/update-user-status/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
            username: username,
            is_active: newState
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("Request failed");
        return res.json();
    })
    .then(data => {

        alert(data.message);

        // Update button text
        link.textContent = newState ? "Deactivate" : "Activate";

        // Update dataset
        link.dataset.active = newState;

        // Update row
        const row = link.closest("tr");
        row.dataset.active = newState;

    })
    .catch(error => {
        console.error("Error:", error);
    });

});


</script><!--
<script>
document.addEventListener("click", function (e) {

    const button = e.target.closest(".partnership-btn");
    if (!button) return;

    const username = button.dataset.username;

    fetch(`/api/deed/${username}/`)
        .then(res => res.json())
        .then(data => {

            document.getElementById("deedUsername").innerText = username;

            let html = "";

            function buildSection(title, field) {

                html += `<h6 class="mt-3">${title}</h6>`;

                html += `
                <div class="table-responsive">
                <table class="table table-bordered table-sm text-center">
                    <thead class="table-dark">
                        <tr>
                `;

                const hideClient =
                    field === "match_share" || field === "casino_share";

                data.forEach(level => {
                    if (hideClient && level.role === "Client") return;
                    html += `<th>${level.role}</th>`;
                });

                html += `</tr></thead><tbody><tr>`;

                data.forEach(level => {
                    if (hideClient && level.role === "Client") return;
                    html += `<td>${level[field] ?? 0}</td>`;
                });

                html += `</tr></tbody></table></div>`;
            }

            buildSection("Match Share", "match_share");
            buildSection("Casino Share", "casino_share");
            buildSection("Match Commission", "match_commission");
            buildSection("Session Commission", "session_commission");
            buildSection("Casino Commission", "casino_commission");

            document.getElementById("deedContent").innerHTML = html;

            const modal = new bootstrap.Modal(
                document.getElementById("partnershipModal")
            );
            modal.show();
        })
        .catch(error => {
            console.error(error);
            alert("Failed to load partnership data");
        });

});
</script>-->
<script>
    document.addEventListener("click", function (e) {

    const button = e.target.closest(".partnership-btn");
    if (!button) return;

    const username = button.dataset.username;

    fetch(`/api/branch-deed/${username}/`)
        .then(res => {
            if (!res.ok) {
                throw new Error("Failed to fetch deed");
            }
            return res.json();
        })
        .then(data => {

            document.getElementById("deedUsername").innerText = username;

            let html = "";

            function buildSection(title, field) {

                html += `<h6 class="mt-3">${title}</h6>`;

                html += `
                <div class="table-responsive">
                <table class="table table-bordered table-sm text-center">
                    <thead class="table-dark">
                        <tr>
                `;

                const hideClient =
                    field === "match_share" || field === "casino_share";

                data.forEach(level => {
                    if (hideClient && level.role === "Client") return;
                    html += `<th>${level.role}</th>`;
                });

                html += `</tr></thead><tbody><tr>`;

                data.forEach(level => {
                    if (hideClient && level.role === "Client") return;
                    html += `<td>${level[field] ?? 0}</td>`;
                });

                html += `</tr></tbody></table></div>`;
            }

            buildSection("Match Share", "match_share");
            buildSection("Casino Share", "casino_share");
            buildSection("Match Commission", "match_commission");
            buildSection("Session Commission", "session_commission");
            buildSection("Casino Commission", "casino_commission");

            document.getElementById("deedContent").innerHTML = html;

            const modal = new bootstrap.Modal(
                document.getElementById("partnershipModal")
            );
            modal.show();
        })
        .catch(error => {
            console.error(error);
            alert("Failed to load partnership data");
        });

});
</script>
 <!--to hide the commission fields using class commission in commission fields-->
<script>
function toggleCommissionFields() {
    var commissionType = document.querySelector("select[name='match_comm_type']");
    if (!commissionType) return;

    var commissionFields = document.querySelectorAll(".commission");

    commissionFields.forEach(function (el) {
        var parentCol = el.closest(".col-md-6");

        // Show ONLY when Bet by bet selected
        if (commissionType.value === "bet_by_bet") {
            parentCol.style.display = "";
        } else {
            parentCol.style.display = "none";
        }
    });
}

// Run on page load
document.addEventListener("DOMContentLoaded", function () {
    toggleCommissionFields();
});

// Run when dropdown changes
document.addEventListener("change", function (e) {
    if (e.target && e.target.name === "match_comm_type") {
        toggleCommissionFields();
    }
});
</script>
<script>
function resetPassword() {
    const newPassword = document.getElementById("newPassword").value.trim();

    if (!newPassword) {
        alert("Please enter a new password.");
        return;
    }

    fetch("{% url 'simple_password_reset' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ new_password: newPassword })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Copy credentials to clipboard
            const credentials =
`Username: {{ request.user.username }}
Password: ${newPassword}
URL: ${window.location.origin}`;
            navigator.clipboard.writeText(credentials).then(() => {
                console.log("Copied to clipboard");
            });

            // Show success message
            const msg = document.getElementById("resetMessage");
            msg.style.display = "block";
            msg.innerText = "Password updated & copied to clipboard!";
            document.getElementById("newPassword").value = "";
        } else {
            alert(data.error || "Something went wrong");
        }
    })
    .catch(err => alert("Error: " + err));
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const toggle = document.getElementById("toggleShare");
    const parentField = document.getElementById("parent_match_share");
    const childField = document.getElementById("child_match_Share");

    if (!toggle || !parentField || !childField) {
        console.log("Elements not found");
        return;
    }

    toggle.addEventListener("change", function () {
        if (this.checked) {
            parentField.readOnly = false;
            childField.readOnly = true;
        } else {
            parentField.readOnly = true;
            childField.readOnly = false;
        }
    });

});
</script>
</html>