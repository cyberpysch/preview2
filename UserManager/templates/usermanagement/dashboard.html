{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'usermanagement/css/style.css' %}">
</head>
<body>

<div class="page-wrapper">
    <nav id="sidebar" class="bg-dark text-white shadow position-fixed h-100">
        <div class="p-3"><h5 class="fw-bold text-info mb-0">PROINPLAY</h5></div>
        <hr class="mt-0 opacity-25">
        <ul class="nav nav-pills flex-column mb-auto px-2">
            <li><a href="#" id="defaultDashboardView" class="nav-link text-white active mb-1">Dashboard</a></li>
            <li>
                <a href="#roleSubmenu" data-bs-toggle="collapse" class="nav-link text-white d-flex justify-content-between">
                    <span>{{ role }}</span><span>▼</span>
                </a>
                <ul id="roleSubmenu" class="collapse list-unstyled ps-3 mt-1">
                    {% for role_name in downline_roles %}
                    <li><a href="#" class="nav-link text-white-50 role-link" data-role="{{ role_name }}">{{ role_name }}</a></li>
                    {% endfor %}
                </ul>
            </li>
        </ul>
    </nav>

    <div class="flex-grow-1 d-flex flex-column">
        <header class="custom-header d-flex align-items-center px-3 sticky-top">
            <button class="btn btn-sm btn-outline-dark d-md-none me-2" id="sidebarToggle">☰</button>
            <div class="flex-grow-1 d-flex justify-content-between align-items-center">
                <span class="fw-bold" data-username="{{ request.user.username }}">{{ request.user.username }} <span class="badge bg-info text-dark ms-2">{{ role }}</span></span>
                <a href="/logout" class="btn btn-sm btn-danger">Logout</a>
            </div>
        </header>

        <main id="content" class="p-4">
          <div id="dashboardContent">
    <div class="container-fluid px-0 mb-4">
        <div class="row g-0 custom-stats-row mb-1">
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MY USER NAME</div>
                <div class="stats-value text-uppercase">{{ request.user.username }}({{ role }})</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MY LEVEL</div>
                <div class="stats-value text-uppercase">{{ role }}</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">BALANCE</div>
                <div class="stats-value">{{ coins }}</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MEMBERS</div>
                <div class="stats-value">{{ members_count }}</div>
            </div>
        </div>

        <div class="row g-0 custom-stats-row">
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MY SHARE</div>
                <div class="stats-value">{{ my_share }} %</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">COMPANY SHARE</div>
                <div class="stats-value">{{ company_share|default:"0" }} %</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">MATCH COMMISSION</div>
                <div class="stats-value">{{ match_commission }} %</div>
            </div>
            <div class="col-6 col-md-3 stats-cell">
                <div class="stats-label">SESSION COMMISSION</div>
                <div class="stats-value">{{ session_commission|default:"0" }} %</div>
            </div>
        </div>
    </div>
</div>
            <div id="dynamicContent" style="display:none;"></div>
        </main>
    </div>
</div>

<div class="modal fade" id="uplineModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white py-2">
                <h6 class="modal-title">Select Upline Manager</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <label class="small fw-bold text-muted">Select Parent</label>
                <select class="form-select mb-4" id="parentSelect"></select>
                <button class="btn btn-primary w-100" onclick="proceedToRegistration()">Proceed to Registration</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script src="{% static 'usermanagement/js/dashboard.js' %}"></script>
</body>
<script>
/**
 * Main function to handle the Edit User flow
 */
function handleEditClick(username) {
    const dynamicDiv = document.getElementById('dynamicContent');
    const dashDiv = document.getElementById('dashboardContent');

    // UI Feedback: Show loading state
    dashDiv.style.display = 'none';
    dynamicDiv.style.display = 'block';
    dynamicDiv.innerHTML = `
        <div class="text-center p-5">
            <div class="spinner-border text-primary"></div>
            <p>Loading Profile for ${username}...</p>
        </div>`;

    // 1. Fetch the Form HTML Template
    fetch(`/get-edit-form/?username=${username}`)
        .then(res => {
            if (!res.ok) throw new Error("Failed to load form template");
            return res.text();
        })
        .then(html => {
            dynamicDiv.innerHTML = html;
            
            // 2. Fetch the Actual Account Data to fill the form
            // URL matches: path('api/get-account-data/<str:username>/', ...)
            return fetch(`/api/get-account-data/${username}/`);
        })
        .then(res => {
            if (!res.ok) throw new Error(`Data fetch failed: ${res.status}`);
            return res.json();
        })
        .then(data => {
            const form = document.getElementById('editUserForm');
            if (!form) return;

            // 3. Populate Form Fields automatically
            Object.keys(data).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = Boolean(data[key]);
                    } else {
                        input.value = data[key];
                    }
                }
            });

            // 4. Attach the Submit Event Listener
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // Stop page refresh/GET request
                
                const formData = new FormData(form);
                const jsonData = Object.fromEntries(formData.entries());

                // Manually handle checkboxes (FormData skips unchecked boxes)
                const checkBoxes = form.querySelectorAll('input[type="checkbox"]');
                checkBoxes.forEach(cb => {
                    jsonData[cb.name] = cb.checked;
                });

                // 5. Send POST to Save Data
                // URL matches: path('api/accounts/edit/<str:username>/', ...)
                fetch(`/api/accounts/edit/${username}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(jsonData)
                })
                .then(res => res.json())
                .then(result => {
                    if (result.status === 'success') {
                        alert("Successfully Updated!");
                        // Optional: return to dashboard
                        // location.reload(); 
                    } else {
                        alert("Error: " + result.message);
                    }
                })
                .catch(err => {
                    console.error("Save Error:", err);
                    alert("Failed to save changes.");
                });
            });
        })
        .catch(err => {
            console.error("Edit Flow Error:", err);
            dynamicDiv.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
        });
}

/**
 * Utility: Get CSRF Token for Django POST requests
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
<script>

function handleDepositClick(username) {

    const modalElement = document.getElementById("depositModal");

    if (!modalElement) {
        console.error("depositModal not found");
        return;
    }

    document.getElementById("depositUsername").value = username;
    document.getElementById("depositAmount").value = "";

    const depositModal = new bootstrap.Modal(modalElement);
    depositModal.show();
}

function submitDeposit() {

    const username = document.getElementById("depositUsername").value;
    const amount = parseInt(document.getElementById("depositAmount").value);

    if (!amount || amount <= 0) {
        alert("Enter valid amount");
        return;
    }

    fetch("/api/deposit-coins/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
            username: username,
            amount: amount
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Deposit successful");
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(() => alert("Server error"));
}


/* CSRF helper (safe for Django) */
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

</script>
<script>
    function handleWithdrawClick(username) {

    const modalElement = document.getElementById("withdrawModal");

    document.getElementById("withdrawUsername").value = username;
    document.getElementById("withdrawAmount").value = "";

    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}


function submitWithdraw() {

    const username = document.getElementById("withdrawUsername").value;
    const amount = parseInt(document.getElementById("withdrawAmount").value);

    if (!amount || amount <= 0) {
        alert("Enter valid amount");
        return;
    }

    fetch("/api/withdraw-coins/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({
            username: username,
            amount: amount
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert("Withdraw successful");
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(() => alert("Server error"));
}

</script>
<script>
    let statementState = {
    username: null,
    currentPage: 1,
    totalPages: 1,
    startDate: null,
    endDate: null
};

function handleStatementClick(username) {

    statementState.username = username;
    statementState.currentPage = 1;
    statementState.startDate = null;
    statementState.endDate = null;

    const dashDiv = document.getElementById("dashboardContent");
    const dynamicDiv = document.getElementById("dynamicContent");

    dashDiv.style.display = "none";
    dynamicDiv.style.display = "block";

    fetch(`/accounts/statement-partial/`)
        .then(res => res.text())
        .then(html => {
            dynamicDiv.innerHTML = html;
            loadStatement();
        });
}

function loadStatement() {

    let url = `/api/account-statement/?username=${statementState.username}&page=${statementState.currentPage}`;

    if (statementState.startDate && statementState.endDate) {
        url += `&start_date=${statementState.startDate}&end_date=${statementState.endDate}`;
    }

    fetch(url)
        .then(res => res.json())
        .then(data => {

            document.getElementById("totalRecords").innerText = data.total_records;

            statementState.totalPages = data.total_pages;
            document.getElementById("currentPageNumber").innerText = data.current_page;

            renderStatementTable(data.results);
            updatePaginationButtons();
        });
}

function renderStatementTable(results) {

    const tbody = document.getElementById("statementTableBody");
    tbody.innerHTML = "";

    results.forEach(tx => {

        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${tx.datetime}</td>
            <td>${tx.description}</td>
            <td class="text-end">${parseFloat(tx.prev_balance).toFixed(2)}</td>
            <td class="text-end ${tx.cr > 0 ? 'text-success' : ''}">
                ${parseFloat(tx.cr).toFixed(2)}
            </td>
            <td class="text-end ${tx.dr > 0 ? 'text-danger' : ''}">
                ${parseFloat(tx.dr).toFixed(2)}
            </td>
            <td class="text-end text-success">
                ${parseFloat(tx.comm_plus).toFixed(2)}
            </td>
            <td class="text-end text-danger">
                ${parseFloat(tx.comm_minus).toFixed(2)}
            </td>
            <td class="text-end">${parseFloat(tx.current_balance).toFixed(2)}</td>
        `;

        tbody.appendChild(tr);
    });
}


function changeStatementPage(direction) {

    const newPage = statementState.currentPage + direction;

    if (newPage < 1 || newPage > statementState.totalPages) return;

    statementState.currentPage = newPage;
    loadStatement();
}

function updatePaginationButtons() {

    document.getElementById("prevPageBtn").disabled =
        statementState.currentPage <= 1;

    document.getElementById("nextPageBtn").disabled =
        statementState.currentPage >= statementState.totalPages;
}

function applyStatementFilter() {

    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;

    if (!start || !end) {
        alert("Both dates are required");
        return;
    }

    if (start > end) {
        alert("Start date cannot be greater than end date");
        return;
    }

    statementState.startDate = start;
    statementState.endDate = end;
    statementState.currentPage = 1;

    loadStatement();
}

function resetStatementFilter() {

    document.getElementById("startDate").value = "";
    document.getElementById("endDate").value = "";

    statementState.startDate = null;
    statementState.endDate = null;
    statementState.currentPage = 1;

    loadStatement();
}

function closeStatement() {

    document.getElementById("dynamicContent").style.display = "none";
    document.getElementById("dashboardContent").style.display = "block";
}

</script>
<script>
$(document).on("click", ".account-operations-link", function(e) {
    e.preventDefault();

    var url = $(this).attr("href");

    $.ajax({
        url: url,
        type: "GET",
        success: function(response) {
            $("#operations-container").html(response);
        },
        error: function(xhr) {
            console.log("Error:", xhr.responseText);
        }
    });
});

</script>
<script>
    document.addEventListener("click", function (e) {

    const link = e.target.closest(".toggle-status");
    if (!link) return;

    e.preventDefault();

    const username = link.dataset.username;
    const currentState = link.dataset.active.trim().toLowerCase() === "true";
    const newState = !currentState;

    fetch("/api/update-user-status/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify({
            username: username,
            is_active: newState
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("Request failed");
        return res.json();
    })
    .then(data => {

        alert(data.message);

        // Update button text
        link.textContent = newState ? "Deactivate" : "Activate";

        // Update dataset
        link.dataset.active = newState;

        // Update row
        const row = link.closest("tr");
        row.dataset.active = newState;

    })
    .catch(error => {
        console.error("Error:", error);
    });

});


</script>
</html>